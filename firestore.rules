<<<<<<< HEAD
<<<<<<< HEAD
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /patients/{patientId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null
        && request.resource.data.keys().hasOnly([
          'name',
          'age',
          'condition',
          'lastSession',
          'therapistNotes',
          'totalHours',
          'avgGripStrength',
          'goalsCompleted',
          'targetStrength',
          'avatarUrl',
          'avatarHint',
          'gripStrengthHistory',
          'therapyHoursHistory'
        ])
        && request.resource.data.name is string
        && request.resource.data.condition is string
        && request.resource.data.avatarUrl is string
        && request.resource.data.avatarHint is string
        && request.resource.data.lastSession is string
        && request.resource.data.age is number
        && request.resource.data.totalHours is number
        && request.resource.data.avgGripStrength is number
        && request.resource.data.goalsCompleted is number
        && request.resource.data.targetStrength is number
        && request.resource.data.gripStrengthHistory is list
        && request.resource.data.therapyHoursHistory is list;
      allow delete: if false;
    }
  }
}
=======
/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model where all data is nested under a user's unique ID (`/users/{userId}`). This ensures that by default, users can only access their own information, providing strong data privacy for patients and therapists.
 *
 * Data Structure: The database is organized around a top-level `users` collection. Each user document serves as the root for their specific data, such as a `patient` or `therapist` profile. Therapists own `exercisePrograms`, which contain `exercises`. Patients assigned to a program can create `progressRecords` for those exercises, which are stored under the therapist's data tree but are owned by the patient.
 *
 * Key Security Decisions:
 * - Default Deny: All paths are closed by default. Access must be granted explicitly.
 * - Strict Ownership: All data is owned by a user. Rules for subcollections are based on the ownership of the root user document in the path.
 * - Shared Access for Patients: Patients are granted read-only access to exercise programs and exercises they have been assigned to. This is managed via a denormalized `patientIds` array on the `ExerciseProgram` document. Patients cannot list all of a therapist's programs.
 * - Patient-Owned Progress: Patients create and own their `progressRecords`. While stored under a therapist's program structure for organizational purposes, only the patient can create, update, or delete their own records. The therapist has read-only access for monitoring.
 *
 * Denormalization for Authorization: To enable efficient and secure access, authorization data is denormalized. The `ExerciseProgram` document contains a `patientIds` array. This avoids complex and non-performant queries in security rules, allowing a simple check to see if a patient has been granted access.
 *
 * Structural Segregation: User data is strictly segregated. Patient and Therapist profiles are in separate subcollections under `/users/{userId}`. This prevents data leakage and simplifies rules by ensuring all documents within a given path share the same security context.
 */
=======
>>>>>>> 4cbf0a3 (I see this error with the app, reported by NextJS, please fix it. The er)
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // Rules for the 'users' collection
    match /users/{userId} {
      // A user can create their own document.
      allow create: if isSignedIn() && request.auth.uid == userId;

      // A user can only read their own document.
      allow read: if isSignedIn() && request.auth.uid == userId;
      
      // A user can update their own name.
      allow update: if isSignedIn() && request.auth.uid == userId && request.resource.data.keys().hasOnly(['name']);
    }

    // Rules for the 'patients' collection
    match /patients/{patientId} {
      // READ: 
      // - A therapist can GET a single patient document if they are the assigned therapist.
      // - A therapist can LIST patients ONLY if their query filters by their own therapistId.
      allow read: if isSignedIn() 
                  && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isTherapist == true
                  && (resource == null || resource.data.therapistId == request.auth.uid);

      // WRITE (Create, Update, Delete)
      // A therapist can create, update, or delete a patient document if they are the assigned therapist.
      allow write: if isSignedIn() 
                   && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isTherapist == true
                   && (request.resource.data.therapistId == request.auth.uid || resource.data.therapistId == request.auth.uid);
    }
  }
}
<<<<<<< HEAD
>>>>>>> 4abd708 (Set up a Firebase backend)
=======
>>>>>>> 4cbf0a3 (I see this error with the app, reported by NextJS, please fix it. The er)
