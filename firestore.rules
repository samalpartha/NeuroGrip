<<<<<<< HEAD
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /patients/{patientId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null
        && request.resource.data.keys().hasOnly([
          'name',
          'age',
          'condition',
          'lastSession',
          'therapistNotes',
          'totalHours',
          'avgGripStrength',
          'goalsCompleted',
          'targetStrength',
          'avatarUrl',
          'avatarHint',
          'gripStrengthHistory',
          'therapyHoursHistory'
        ])
        && request.resource.data.name is string
        && request.resource.data.condition is string
        && request.resource.data.avatarUrl is string
        && request.resource.data.avatarHint is string
        && request.resource.data.lastSession is string
        && request.resource.data.age is number
        && request.resource.data.totalHours is number
        && request.resource.data.avgGripStrength is number
        && request.resource.data.goalsCompleted is number
        && request.resource.data.targetStrength is number
        && request.resource.data.gripStrengthHistory is list
        && request.resource.data.therapyHoursHistory is list;
      allow delete: if false;
    }
  }
}
=======
/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model where all data is nested under a user's unique ID (`/users/{userId}`). This ensures that by default, users can only access their own information, providing strong data privacy for patients and therapists.
 *
 * Data Structure: The database is organized around a top-level `users` collection. Each user document serves as the root for their specific data, such as a `patient` or `therapist` profile. Therapists own `exercisePrograms`, which contain `exercises`. Patients assigned to a program can create `progressRecords` for those exercises, which are stored under the therapist's data tree but are owned by the patient.
 *
 * Key Security Decisions:
 * - Default Deny: All paths are closed by default. Access must be granted explicitly.
 * - Strict Ownership: All data is owned by a user. Rules for subcollections are based on the ownership of the root user document in the path.
 * - Shared Access for Patients: Patients are granted read-only access to exercise programs and exercises they have been assigned to. This is managed via a denormalized `patientIds` array on the `ExerciseProgram` document. Patients cannot list all of a therapist's programs.
 * - Patient-Owned Progress: Patients create and own their `progressRecords`. While stored under a therapist's program structure for organizational purposes, only the patient can create, update, or delete their own records. The therapist has read-only access for monitoring.
 *
 * Denormalization for Authorization: To enable efficient and secure access, authorization data is denormalized. The `ExerciseProgram` document contains a `patientIds` array. This avoids complex and non-performant queries in security rules, allowing a simple check to see if a patient has been granted access.
 *
 * Structural Segregation: User data is strictly segregated. Patient and Therapist profiles are in separate subcollections under `/users/{userId}`. This prevents data leakage and simplifies rules by ensuring all documents within a given path share the same security context.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     * This is the primary function for establishing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the document being requested already exists in Firestore.
     * Used to prevent updates or deletes on non-existent documents.
     */
    function docExists() {
      return resource != null;
    }

    /**
     * Returns true if the user is the owner of an existing document.
     * A standard check for all update and delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && docExists();
    }

    /**
     * Checks if the currently authenticated user is listed in the patientIds
     * array of a specific ExerciseProgram document. This grants them read access.
     */
    function isAssignedPatient(therapistId, programId) {
      let programPath = /databases/$(database)/documents/users/$(therapistId)/exercisePrograms/$(programId);
      return isSignedIn() && request.auth.uid in get(programPath).data.patientIds;
    }

    /**
     * Validates that a required ownership field in a new document
     * matches the UID of the user creating it.
     */
    function isCreatingOwnDoc(fieldName) {
      return request.resource.data[fieldName] == request.auth.uid;
    }

    /**
     * Validates that a required relational field in a new document
     * matches the ID from the document's path.
     */
    function isPathConsistent(pathId, fieldName) {
      return request.resource.data[fieldName] == pathId;
    }

    /**
     * Validates that a specific field is not being changed during an update.
     * Used to protect immutable fields like creator IDs or relational keys.
     */
    function isImmutable(fieldName) {
      return request.resource.data[fieldName] == resource.data[fieldName];
    }


    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description A user can create their own profile and can fully manage it after creation. No other user can read or write to it.
     * @path /users/{userId}
     * @allow (create) An authenticated user creating their own user document: auth.uid === userId.
     * @deny (get) Another user (auth.uid: 'user-xyz') trying to read '/users/user-abc'.
     * @principle Restricts access to a user's own data tree and allows for self-creation of a root user profile.
     */
    match /users/{userId} {
      allow get, list, update, delete: if isOwner(userId);
      allow create: if isOwner(userId) && isPathConsistent(userId, 'id');
    }

    /**
     * @description The therapist profile can only be created and managed by the parent user.
     * @path /users/{userId}/therapist/{therapistId}
     * @allow (create) The owner user (auth.uid: 'user-abc') creating a document at '/users/user-abc/therapist/therapist-123'.
     * @deny (update) Another user trying to update a therapist profile they do not own.
     * @principle Enforces strict ownership within a user's data tree.
     */
    match /users/{userId}/therapist/{therapistId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && isPathConsistent(userId, 'userId');
      allow update: if isExistingOwner(userId) && isImmutable('userId');
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description The patient profile can only be created and managed by the parent user.
     * @path /users/{userId}/patient/{patientId}
     * @allow (create) The owner user (auth.uid: 'user-abc') creating a document at '/users/user-abc/patient/patient-123'.
     * @deny (get) Another user trying to read a patient profile they do not own.
     * @principle Enforces strict ownership within a user's data tree.
     */
    match /users/{userId}/patient/{patientId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && isPathConsistent(userId, 'userId');
      allow update: if isExistingOwner(userId) && isImmutable('userId');
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Exercise programs can only be managed by the therapist who created them. Patients assigned to the program can read it.
     * @path /users/{therapistId}/exercisePrograms/{programId}
     * @allow (get) A patient (auth.uid: 'patient-xyz') reading a program they are assigned to.
     * @deny (list) A patient trying to list all programs created by a therapist.
     * @principle Enforces document ownership for writes, but allows shared, read-only access for a list of collaborators (patients).
     */
    match /users/{therapistId}/exercisePrograms/{programId} {
      allow get: if isOwner(therapistId) || isAssignedPatient(therapistId, programId);
      allow list: if isOwner(therapistId);
      allow create: if isOwner(therapistId) && isPathConsistent(therapistId, 'therapistId');
      allow update: if isExistingOwner(therapistId) && isImmutable('therapistId');
      allow delete: if isExistingOwner(therapistId);
    }

    /**
     * @description Exercises inherit permissions from their parent program. Only the therapist can manage them, but assigned patients can read them.
     * @path /users/{therapistId}/exercisePrograms/{programId}/exercises/{exerciseId}
     * @allow (list) An assigned patient (auth.uid: 'patient-xyz') listing exercises for a program they are a part of.
     * @deny (create) A patient trying to create a new exercise within a therapist's program.
     * @principle Secures a subcollection by checking permissions on its parent document.
     */
    match /users/{therapistId}/exercisePrograms/{programId}/exercises/{exerciseId} {
      allow get, list: if isOwner(therapistId) || isAssignedPatient(therapistId, programId);
      allow create, update, delete: if isOwner(therapistId);
    }

    /**
     * @description Progress records can be created by patients assigned to the program. Only the patient who created a record can edit or delete it. The therapist can read all records for monitoring.
     * @path /users/{therapistId}/exercisePrograms/{programId}/exercises/{exerciseId}/progressRecords/{recordId}
     * @allow (create) An assigned patient (auth.uid: 'patient-xyz') creating a progress record for themselves.
     * @deny (update) A therapist trying to modify a patient's progress record.
     * @principle Implements a dual-access model: The patient has ownership for writes, while the therapist has read-only oversight.
     */
    match /users/{therapistId}/exercisePrograms/{programId}/exercises/{exerciseId}/progressRecords/{recordId} {
      allow get: if isOwner(therapistId) || isOwner(resource.data.patientId);
      allow list: if isOwner(therapistId);
      allow create: if isAssignedPatient(therapistId, programId) && isCreatingOwnDoc('patientId');
      allow update, delete: if docExists() && isOwner(resource.data.patientId);
    }
  }
}
>>>>>>> 4abd708 (Set up a Firebase backend)
